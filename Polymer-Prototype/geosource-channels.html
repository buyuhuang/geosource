<link rel="import" href="components/polymer/polymer.html">
<link rel="import" href="components/core-item/core-item.html">
<link rel="import" href="components/paper-input/paper-input.html">

<polymer-element name="geosource-channels" attributes="channels">

  <template>

    <style>
      :host {
        display: block;
        position: relative;
        background-color: white;
        width: 100%;
        font-weight: 300;
      }
      paper-input {
        padding-bottom: 10px;
      }
      core-submenu {
        padding: 10px;
      }
      core-submenu::shadow #submenu {
        margin-left: 15px;
      }
/*      core-item.core-selected {
        color: #3C8670;
      }*/
      .unsubscribe_button {
        color: #FF6666;
      }
      .subscribe_button {
        color: #5CC0A2;
      }
      #subscribed {
        padding: 0;
      }
      core-menu {
        margin: 0;
      }
    </style>

    <core-submenu opened active selected="0" icon="settings-remote" label="Channels" on-core-select="{{channelSelected}}">
      <core-menu id="core_menu" selected="0">
        <core-item label="All"></core-item>
        <core-item label="Subscribed"></core-item>
        <template repeat="{{channel in subscribedChannels}}">
          <core-item label="{{channel.name}}" horizontal justified layout>
            <paper-icon-button icon="close" class="unsubscribe_button" 
              on-tap="{{unsubscribe}}">
            </paper-icon-button>
          </core-item>
        </template>
        <div center horizontal layout class="search">
          <paper-input id="search_input" 
            label="Search for channels..."
            on-value-change="{{searchChannels}}">
          </paper-input>
          <paper-icon-button icon="search"></paper-icon-button> 
       </div>
        <template repeat="{{channel in searchedChannels}}">
          <core-item label="{{channel.name}}" horizontal justified layout>
            <paper-icon-button icon="add" class="subscribe_button" on-tap="{{subscribe}}"></paper-icon-button>
          </core-item>
        </template>
      </core-menu>
    </core-submenu>
  </template>

  <script>
  Polymer({

    selected: "All",
    channels: null,
    subscribedChannels: null,
    seachedChannels: null,

    channelsChanged: function() {
      this.channels.sort();
      this.subscribedChannels = []
      for(i=0; i<this.channels.length; i++) {
        if(this.channels[i].subscribed) {
          this.subscribedChannels.push(this.channels[i])
        }
      }
    },

    /**
     * Fires a 'selection-change' event, and changes the 'selected' attribute to
     * whichever attribute has been selected.
     */
    channelSelected: function(e) {
      if(e.detail.item.label) {
        this.selected = e.detail.item.label;
        this.fire('filter-change');
      }
    },

    filterPosts: function(posts) {
      var includedPosts = [];

      switch (this.selected) {
        case 'All':
          includedPosts = posts.slice(0);
          break;
        case 'Subscribed':
          for(i=0; i<posts.length; i++) {
            for(j=0; j<this.subscribedChannels.length; j++) {
              if(posts[i].channel == this.subscribedChannels[j].name)
              {
                includedPosts.push(posts[i]);
                break;
              }
            }
          }
          break;
        default:
          for(i=0; i<posts.length; i++) {
            if(posts[i].channel == this.selected) {
              includedPosts.push(posts[i]);
            }
          }
          break;
      }

      return includedPosts;
    },

    searchChannels: function() {

      var search = this.$.search_input.value;

      if(search == '') {
        this.searchedChannels = [];
        return;
      }

      var regexString = "^";
      for(i=0; i<search.length; i++) {
        regexString += search[i] + '.*';
      }

      var regex = new RegExp(regexString, 'i');

      console.log(regexString);

      this.searchedChannels = [];
      for(i=0; i<this.channels.length; i++) {
        if(this.channels[i].name.match(regex)) {
          this.searchedChannels.push(this.channels[i]);
        }
      }
    },

    unsubscribe: function(event, detail, sender) {
      console.log('event', event);
      console.log('detail', detail);
      console.log('sender', sender);
      console.log(sender.templateInstance.model.channel);

      var channel = sender.templateInstance.model.channel;
      channel.subscribed = false;
      this.channelsChanged();
    },

    subscribe: function(event, detail, sender) {
      var channel = sender.templateInstance.model.channel;
      channel.subscribed = true;
      this.channelsChanged();
    }

  });
  </script>
  
</polymer-element>
