<!doctype html>
<html>

<link rel="import" href="geosource-feed.html">
<link rel="import" href="geosource-map.html">
<link rel="import" href="geosource-channels.html">

<link rel="import" href="components/font-roboto/roboto.html">
<link rel="import" href="components/core-header-panel/core-header-panel.html">
<link rel="import" href="components/core-toolbar/core-toolbar.html">
<link rel="import" href="components/paper-tabs/paper-tabs.html">

<link rel="import" href="components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="components/core-icons/communication-icons.html">
<link rel="import" href="components/core-menu/core-menu.html">
<link rel="import" href="components/core-menu/core-submenu.html">
<link rel="import" href="components/core-item/core-item.html">
<link rel="import" href="components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="components/paper-input/paper-input.html">
<link rel="import" href="components/core-icons/hardware-icons.html">
<link rel="import" href="components/paper-dialog/paper-dialog.html">
<link rel="import" href="components/paper-spinner/paper-spinner.html">
<link rel="import" href="components/google-signin/google-signin.html">

<link rel="import" href="post-service/post-service.html">
<link rel="import" href="post-service/channel-service.html">

<polymer-element name="geosource-main">
  <template>
      <style>
        core-header-panel {
          height: 100%;
          overflow: auto;
          -webkit-overflow-scrolling: touch;
        }
        core-toolbar {
          background: #5CC0A2;
          color: white;
        }
        #tabs {
          width: 100%;
          margin: 0;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
        text-transform: uppercase;
        }
        .container {
          margin: 30px;
          margin-bottom: 0;
        }
        #settings_drawer {
          position: absolute;
          top: 0px;
          right: 0px;
          bottom: 0px;
          left: 0px;
          width: 100%;
          height: 100%;
        }
        #section1 {
          box-shadow: rgba(0, 0, 0, 0.0980392) 0px 2px 4px, rgba(0, 0, 0, 0.0980392) 0px 0px 3px;
          background-color: rgb(250, 250, 250);
          overflow-x: auto;
        }
        #section2 {
          height: 100%;
          box-sizing: border-box;
          background-color: rgb(221, 221, 221);
        }
        #feed_drawer {
          position: absolute;
          top: 0px;
          right: 0px;
          bottom: 0px;
          left: 0px;
          width: 100%;
          height: 100%;
        }
        #section3 {
          box-shadow: rgba(0, 0, 0, 0.0980392) 0px 2px 4px, rgba(0, 0, 0, 0.0980392) 0px 0px 3px;
          background-color: rgb(250, 250, 250);
          overflow-x: auto;
        }
        #section4 {
          height: 100%;
          box-sizing: border-box;
          background-color: rgb(221, 221, 221);
        }
        #core_menu {
          font-size: 16px;
          width: 216px;
          position: absolute;
          margin: 20px;
        }
        #toggle_label {
          margin: 15px;
          margin-left: 0;
        }
        @media (min-width: 481px) {
          #tabs {
            width: 200px;
          }
        }
        #dialog {
          overflow-x: auto;
          font-size: 20px;
        }

        #feed {
          width: 100%;
        }

        html /deep/ paper-dialog {
          max-width: 800px;
        }

        core-drawer-panel::shadow #settings_drawer {
          width: 400px;
        }      
  </style>

    <post-service id="post_service" posts="{{allPosts}}"></post-service>
    <channel-service id="channel_service" channels="{{channels}}"></channel-service>

    <paper-dialog id="dialog" role="dialog" backdrop transition="core-transition-center">
      <div flex id="dialog_content"></div>
    </paper-dialog>

    <core-header-panel id="core_header_panel">

        <core-toolbar id="core_toolbar">
          <paper-icon-button icon="menu" id="filter_button" on-tap="{{toggleSettingsDrawer}}"></paper-icon-button>
          <div id="div" one flex center-justified horizontal layout>GeoSource</div>
          <paper-icon-button icon="account-circle" id="feed_button" on-tap="{{toggleFeedDrawer}}"></paper-icon-button>
        </core-toolbar>

        <section id="section">
          <core-drawer-panel transition responsivewidth="800px" selected="main" disableEdgeSwipe id="settings_drawer">
            <section id="section1" drawer>
              <!-- <google-signin clientId="301689362567-1df5lo4vk81q9glt09k8vb0v8mk7n0kq.apps.googleusercontent.com"></google-signin> -->
              <core-menu multi notap selected="0" selectedindex="0" id="core_menu">
                <core-submenu opened active id="core_submenu" icon="settings" label="Filters">
                  <div center horizontal layout id="toggle_label">
                    <div flex>All</div>
                    <paper-toggle-button checked id="all_toggle_button" on-change="{{filterPosts}}"></paper-toggle-button>
                  </div>
                  <div center horizontal layout id="toggle_label">
                    <div flex>Mine</div>
                    <paper-toggle-button checked id="mine_toggle_button" disabled on-change="{{filterPosts}}"></paper-toggle-button>
                  </div>
                  <div center horizontal layout id="toggle_label">
                    <div flex>Favorites</div>
                    <paper-toggle-button checked id="favorite_toggle_button" disabled on-change="{{filterPosts}}"></paper-toggle-button>
                  </div>
                </core-submenu>
                <geosource-channels id="channels" 
                  channels="{{channels}}" 
                  on-selection-change="{{filterPosts}}">
                </geosource-channels>                
              </core-menu>

            </section>

            <section id="section2" main>
              <core-drawer-panel transition drawerwidth="400px" responsivewidth="800px" selected="main" disableEdgeSwipe narrow rightdrawer id="feed_drawer">
                <section id="section3" drawer>
                  <div class="container" layout vertical center>
                    <geosource-feed id='feed' 
                        posts="{{filteredPosts}}" 
                        on-open-dialog="{{openDialog}}"
                        on-set-location="{{moveMap}}"
                        on-favorite="{{filterPosts}}">
                    </geosource-feed>
                  </div>
                </section>
                <section id="section4" main>
                  <geosource-map id="map" posts="{{filteredPosts}}" on-open-dialog="{{openDialog}}"></geosource-map>
                </section>
              </core-drawer-panel>
            </section>
          </core-drawer-panel>
        </section>

  </template>

  <script>
    Polymer({

      allPosts: null,
      filteredPosts: null,

      ready: function() {

        var all_toggle = this.$.all_toggle_button;
        var fav_toggle = this.$.favorite_toggle_button;
        var mine_toggle = this.$.mine_toggle_button;

        all_toggle.addEventListener('change', function() {
          if(all_toggle.checked) {
            fav_toggle.disabled = true;
            mine_toggle.disabled = true;
          }
          else {
            fav_toggle.disabled = false;
            mine_toggle.disabled = false;
          }
        });  
      },

      filterPosts: function() {
        var selectedChannel = this.$.channels.selected;
        var all_toggle = this.$.all_toggle_button;
        var fav_toggle = this.$.favorite_toggle_button;

        var postIncluded = [];
        for(i=0; i<this.allPosts.length; i++)
        {
          postIncluded[i] = false;
        }

        for(i=0; i<this.allPosts.length; i++)
        {
            postIncluded[i] = (postIncluded[i] || this.allPosts[i].channel == selectedChannel || selectedChannel == 'All');
        }

        for(i=0; i<this.allPosts.length; i++) {
          postIncluded[i] = (all_toggle.checked && postIncluded[i]) || (!all_toggle.checked && fav_toggle.checked && this.allPosts[i].favorite && postIncluded[i]);
        }

        var includedPosts = []
        for(i=0; i<this.allPosts.length; i++)
        {
          if(postIncluded[i])
          {
            includedPosts.push(this.allPosts[i]);
          }
        }

        this.filteredPosts = includedPosts;

        console.log("all", this.allPosts);
        console.log("filtered", this.filteredPosts);
      },

      openDialog: function(e) {
        var dialog = this.$.dialog;
        var dialog_content = this.$.dialog_content;

        this.injectBoundHTML(
          '<h2>' + e.detail.post.username + '</h2>' +
          '<p>' + e.detail.post.text + '</p>' +
          '<img src="' + e.detail.post.avatar + '" width="auto" height="auto"/>' +
          '<p>' + e.detail.post.time + '</p>',
          dialog_content);

        dialog.toggle();
      },

      allPostsChanged: function() {
        this.filterPosts();
      },
      channelsChanged: function() {
        this.filterPosts();
      },

      moveMap: function(e) {
        var map = this.$.map;
        map.latitude = e.detail.latitude;
        map.longitude = e.detail.longitude;
      },

      toggleFeedDrawer: function() {
        var feed_drawer = this.$.feed_drawer;
        var settings_drawer = this.$.settings_drawer;
        var map = this.$.map;
        
        settings_drawer.closeDrawer();
        if(feed_drawer.narrow) {
          feed_drawer.forceNarrow = false;
          feed_drawer.togglePanel();
        }
        else {
          feed_drawer.forceNarrow = true;
        }

        setTimeout(function(){ map.resize() }, 500);
      },
      toggleSettingsDrawer: function() {
        var settings_drawer = this.$.settings_drawer;
        var feed_drawer = this.$.feed_drawer;
        var map = this.$.map;

        feed_drawer.closeDrawer();
        if(settings_drawer.narrow) {
          settings_drawer.forceNarrow = false;
          settings_drawer.togglePanel();
        }
        else {
          settings_drawer.forceNarrow = true;
        }

        setTimeout(function(){ map.resize() }, 500);
      },

    });

  </script>

</polymer-element>



